<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.course.mapper.CourseSelectionMapper">

    <!-- 结果映射 -->
    <resultMap id="CourseSelectionWithDetailsMap" type="com.course.entity.CourseSelection">
        <id column="id" property="id"/>
        <result column="student_id" property="studentId"/>
        <result column="course_id" property="courseId"/>
        <result column="selection_time" property="selectionTime"/>
        <result column="status" property="status"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        
        <!-- 学生信息 -->
        <result column="username" property="username"/>
        <result column="student_name" property="studentName"/>
        <result column="email" property="email"/>
        <result column="phone" property="phone"/>
        
        <!-- 课程信息 -->
        <result column="course_code" property="courseCode"/>
        <result column="course_name" property="courseName"/>
        <result column="category" property="category"/>
        <result column="credits" property="credits"/>
        <result column="semester" property="semester"/>
        <result column="teacher_name" property="teacherName"/>
    </resultMap>

    <!-- 分页查询选课记录（包含学生和课程信息） -->
    <select id="selectSelectionPageWithDetails" resultMap="CourseSelectionWithDetailsMap">
        SELECT 
            cs.id,
            cs.student_id,
            cs.course_id,
            cs.selection_time,
            cs.status,
            cs.create_time,
            cs.update_time,
            
            <!-- 学生信息 -->
            u.username,
            u.real_name as student_name,
            u.email,
            u.phone,
            
            <!-- 课程信息 -->
            c.course_code,
            c.course_name,
            c.category,
            c.credits,
            c.semester,
            t.real_name as teacher_name
            
        FROM course_selections cs
        INNER JOIN users u ON cs.student_id = u.id
        INNER JOIN courses c ON cs.course_id = c.id
        LEFT JOIN users t ON c.teacher_id = t.id
        
        <where>
            cs.deleted = 0
            
            <if test="keyword != null and keyword != ''">
                AND (
                    u.real_name LIKE CONCAT('%', #{keyword}, '%')
                    OR u.username LIKE CONCAT('%', #{keyword}, '%')
                    OR c.course_name LIKE CONCAT('%', #{keyword}, '%')
                    OR c.course_code LIKE CONCAT('%', #{keyword}, '%')
                )
            </if>
            
            <if test="courseId != null">
                AND cs.course_id = #{courseId}
            </if>
            
            <if test="semester != null and semester != ''">
                AND c.semester = #{semester}
            </if>
            
            <if test="status != null">
                AND cs.status = #{status}
            </if>
        </where>
        
        ORDER BY cs.selection_time DESC
    </select>

</mapper>
